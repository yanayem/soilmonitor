{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soil Types in Bangladesh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              accent: "#1e40af", 
              darkblue: "#f0f4f8", 
              midblue: "#e2e8f0",
              lightblue: "#cbd5e1",
              cardblue: "#ffffff", 
              inputblue: "#f1f5f9", 
              lighttext: "#0f172a",
              darkcard: "#14213d", 
              darkinput: "#1f2c50", 
              darktext: "#e6f1ff",
              darkbtn:"#065084",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>

  <body
    class="bg-darkblue dark:bg-[rgb(15_23_42/var(--tw-bg-opacity))] text-lighttext dark:text-darktext transition-colors duration-500 min-h-screen"
  >
    {% include "nav.html" %}

    <section class="pt-24 px-4 md:px-10">
      <div class="max-w-6xl mx-auto">
        <h1
          class="text-4xl font-bold text-center mb-8  tex-gray-900 dark:text-accent :dark:drop-shadow-[0_0_15px_#1e40af]"
        >
          Soil Types in Bangladesh
        </h1>

       
        <div class="flex justify-center mb-6">
          <a
            href="{% url 'add_soil_type' %}"
            class="inline-flex items-center gap-2 bg-gray-700 dark:bg-darkbtn text-white dark:text-darkblue font-semibold px-5 py-2 rounded-xl shadow-lg dark:hover:shadow-darkbtn/50 hover:-translate-y-1 transition-all duration-300"
          >
            <i class="fa fa-plus"></i> Add New Soil Type
          </a>
        </div>

        
        <div
          class="space-y-3 mb-6 bg-cardblue dark:bg-darkcard/80 backdrop-blur-md p-5 rounded-2xl shadow-lg border border-gray-200/10 dark:border-white/10 transition-colors duration-300"
        >
          <input
            type="text"
            id="searchInput"
            placeholder="ðŸ” Search Soil Type..."
            class="w-full px-4 py-2 rounded-lg bg-inputblue dark:bg-darkinput text-lighttext dark:text-darktext placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-darkbtn outline-none transition-all duration-300"
          />
          <div class="flex flex-wrap gap-3 mt-3">
            <input
              type="number"
              id="phMin"
              placeholder="Min pH"
              step="0.1"
              class="flex-1 min-w-[100px] px-3 py-2 rounded-lg bg-inputblue dark:bg-darkinput text-lighttext dark:text-darktext focus:ring-2 focus:ring-darkbtn outline-none transition-all duration-300"
            />
            <input
              type="number"
              id="phMax"
              placeholder="Max pH"
              step="0.1"
              class="flex-1 min-w-[100px] px-3 py-2 rounded-lg bg-inputblue  dark:bg-darkinput text-lighttext dark:text-darktext focus:ring-2 focus:ring-darkbtn outline-none transition-all duration-300"
            />
            <button
              id="phFilterBtn"
              class="px-5 py-2 bg-rose-600 dark:bg-darkbtn/40  text-white dark:text-darkblue font-semibold rounded-lg dark:shadow-md dark:hover:shadow-darkbtn hover:scale-105 transition-all"
            >
              <i class="fa fa-filter"></i> Filter
            </button>
            <button
              id="phResetBtn"
              class="px-5 py-2 bg-midblue dark:bg-lightblue text-gray-900 font-semibold rounded-lg hover:bg-lightblue dark:hover:bg-midblue transition-all"
            >
              <i class="fa fa-undo"></i> Reset
            </button>
          </div>
        </div>

        
        <div
          class="overflow-x-auto bg-cardblue dark:bg-darkcard/60 backdrop-blur-xl rounded-2xl shadow-[0_0_40px_rgba(30,64,175,0.15)] border border-gray-200/10 dark:border-white/10 transition-colors duration-300"
        >
          <table
            id="soilTable"
            class="w-full text-sm text-lighttext dark:text-darktext"
          >
            <thead
              class="bg-gray-600 dark:bg-darkbtn  text-white dark:text-darkblue text-left rounded-t-xl"
            >
              <tr>
                <th class="p-3">Name</th>
                <th class="p-3">Description</th>
                <th class="p-3 text-center">pH Range</th>
                <th class="p-3">Suitable Crops</th>
                <th class="p-3">Location</th>
                <th class="p-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for soil in soil_types %}
              <tr
                data-id="{{ soil.id }}"
                class="border-b border-gray-300 dark:border-slate-800 hover:bg-midblue/50 dark:hover:bg-darkinput/50 hover:shadow-inner dark:hover:shadow-darkbtn/20 transition-all duration-300"
              >
                <td class="p-3">{{ soil.name }}</td>
                <td class="p-3">{{ soil.description }}</td>
                <td class="p-3 text-center">
                  {{ soil.ph_min }} - {{ soil.ph_max }}
                </td>
                <td class="p-3">{{ soil.suitable_crops }}</td>
                <td class="p-3">{{ soil.location }}</td>
                <td class="p-3 flex justify-center gap-3">
                  <a
                    href="javascript:void(0)"
                    class="text-blue dark:text-pink-300 hover:scale-125 transition-all"
                    title="Edit"
                    onclick="editRow(this)"
                  >
                    <i class="fa fa-pencil"></i>
                  </a>
                  <a
                    href="javascript:void(0)"
                    class="text-green-400 hover:scale-125 transition-all hidden"
                    title="Save"
                    onclick="saveRow(this)"
                  >
                    <i class="fa fa-check"></i>
                  </a>
                  <a
                    href="{% url 'delete_soil_type' soil.id %}"
                    class="text-red-500 hover:scale-125 transition-all"
                    title="Delete"
                  >
                    <i class="fa fa-trash"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <script>
      
      const inputs = document.querySelectorAll("#searchInput, #phMin, #phMax");
      inputs.forEach((input) => {
        input.addEventListener("input", () => {
          if (input.value.trim() !== "") {
            input.classList.add("ring-2", "ring-darkbtn", "dark:ring-darkbtn/80");
          } else {
            input.classList.remove(
              "ring-2",
              "ring-darkbtn",
              "dark:ring-darkbtn/80"
            );
          }
        });
      });

      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("keyup", () => {
        const filter = searchInput.value.toLowerCase();
        document.querySelectorAll("#soilTable tbody tr").forEach((row) => {
          const name = row.cells[0].textContent.toLowerCase();
          row.style.display = name.includes(filter) ? "" : "none";
        });
      });

      const phMinInput = document.getElementById("phMin");
      const phMaxInput = document.getElementById("phMax");
      const phFilterBtn = document.getElementById("phFilterBtn");
      const phResetBtn = document.getElementById("phResetBtn");

      phFilterBtn.addEventListener("click", () => {
        const min = phMinInput.value ? parseFloat(phMinInput.value) : -Infinity;
        const max = phMaxInput.value ? parseFloat(phMaxInput.value) : Infinity;
        document.querySelectorAll("#soilTable tbody tr").forEach((row) => {
          const phRange = row.cells[2].textContent
            .split("-")
            .map((p) => parseFloat(p.trim()));
          const phMin = phRange[0] || 0;
          const phMax = phRange[1] || 14;
          row.style.display = phMin >= min && phMax <= max ? "" : "none";
        });
      });

      phResetBtn.addEventListener("click", () => {
        phMinInput.value = "";
        phMaxInput.value = "";
        searchInput.value = "";
        document
          .querySelectorAll("#soilTable tbody tr")
          .forEach((row) => (row.style.display = ""));
      });

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          document.cookie.split(";").forEach((cookie) => {
            if (cookie.trim().startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.trim().substring(name.length + 1)
              );
            }
          });
        }
        return cookieValue;
      }

      window.editRow = function (btn) {
        const row = btn.closest("tr");
        row.querySelectorAll("td").forEach((cell, i) => {
          if (i < 5) {
            const text = cell.innerText;
            cell.innerHTML = `<input type='text' value='${text}' class='w-full px-2 py-1 bg-inputblue dark:bg-darkinput text-lighttext dark:text-darktext rounded border border-slate-700 focus:ring-2 focus:ring-darkbtn outline-none transition'/>`;
          }
        });
        btn.classList.add("hidden");
        row.querySelector(".fa-check").parentElement.classList.remove("hidden");
      };

      window.saveRow = function (btn) {
        const row = btn.closest("tr");
        const id = row.dataset.id;
        const inputs = row.querySelectorAll("td input");
        const data = {
          name: inputs[0].value,
          description: inputs[1].value,
          ph_min: inputs[2].value.split("-")[0].trim(),
          ph_max: inputs[2].value.split("-")[1].trim(),
          suitable_crops: inputs[3].value,
          location: inputs[4].value,
        };
        fetch(`/soil-types/edit/${id}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.success) {
              row.cells[0].innerText = data.name;
              row.cells[1].innerText = data.description;
              row.cells[2].innerText = `${data.ph_min} - ${data.ph_max}`;
              row.cells[3].innerText = data.suitable_crops;
              row.cells[4].innerText = data.location;
              btn.classList.add("hidden");
              row
                .querySelector(".fa-pencil")
                .parentElement.classList.remove("hidden");
            } else alert("Update failed!");
          })
          .catch(() => alert("Network error!"));
      };
    </script>
  </body>
</html>
